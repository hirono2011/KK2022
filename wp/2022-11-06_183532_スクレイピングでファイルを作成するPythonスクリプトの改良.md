### スクレイピングでファイルを作成するPythonスクリプトの改良　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中

:CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #参考資料

#####  [スクレイピングでWordPressの記事のテキストを取得し、ファイルも作成するPythonスクリプト](http://hirono-hideki.info/kk2022/2022-10-06_218)

- スクレイピングでWordPressの記事のテキストを取得し、ファイルも作成するPythonスクリプト - 本件刑事告発・非常上告事件＼金沢地方検察庁御中 http://hirono-hideki.i… 

[ 本件刑事告発・非常上告事件＼金沢地方検察庁御中 ](http://hirono-hideki.info/kk2022)

[ ![](http://hirono-hideki.info/kk2022/wp-content/uploads/2022/10/223b1f27b90c9fdc71eef10dee2cb02d-1024x576.jpeg) ](http://hirono-hideki.info/kk2022/2022-10-06_218)

 先日作成した上記のスクリプトですが、いくつか問題があったので見直しをしました。スクレイピングでテキストを取得するのではなく、HTMLを取得してテキストに変換するようにしました。

 整形済みテキストのブロックでも、文字のフォントサイズを変更するためDIVタグを使うと改行のないテキストを取得することになると気がついたからです。変更するとタグの取り扱いで余計な改行が入るようになったので2行以上を1行に置換するようにしました。

 HTMLをテキストに変換すると、行頭に4つの半角スペースがインデントのように入るという問題もありました。この処理を変数内で行うとすべての空行が消えるという謎の現象が発生したので、外部コマンドの処理にしました。

#!/usr/bin/python

"""
　WordPressの記事のテキストをURLを指定して取得。
　オプション--newで指定場所にファイルを作成
　オプション--tagsでタグを指定

　以下実行例

[~] get_text-wl-kk2022_arg.py -l http://hirono-hideki.info/kk2022/2022-10-06_174 --tags="ジャーナリストの江川紹子氏 #モトケンこと矢部善朗弁護士（京都弁護士会）"
### 「検察の汚名は一気に返上になるだろう。」というジャーナリスト清水潔氏のツイート　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中

:CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #ジャーナリストの江川紹子氏 #モトケンこと矢部善朗弁護士（京都弁護士会）

- TW NOSUKE0607（清水 潔） 日時： 2022/10/04 18:27:25 URL： https://twitter.com/NOSUKE0607/status/1577228890094723072  
> 元首相亡き今、特捜部が本気で前首相を狙っているなら検察の汚名は一気に返上になるだろう。さあやれるか検察。  
>   
> 東京地検特捜部が「菅前総理」をロック・オン…ひそかに進む「重大捜査」 https://t.co/Vgjq4MRthj  
元首相亡き今、特捜部が本気で前首相を狙っているなら検察の汚名は一気に返上になるだろう。さあやれるか検察。東京地検特捜部が「菅前総理」をロック・オン…ひそかに進む「重大捜査」 https://t.co/Vgjq4MRthj— 清水 潔 (@NOSUKE0607) October 4, 2022

最終更新日時：2022-10-06_141531

[~] 
"""

from bs4 import BeautifulSoup
from html.parser import HTMLParser
from urllib.request import urlopen
import sys
import pyperclip
import datetime
import re
import argparse
import html2text
import subprocess

#iargs = sys.argv
#base_url=args[1]

#base_url = pyperclip.paste().rstrip('\n')

parser = argparse.ArgumentParser() # 1.インスタンスの作成
parser.add_argument('-l', '--url', help="ブログ記事のURL", type=str) # 2.必要なオプションを追加
parser.add_argument('-n', '--new', help="新規に記録用ファイルを作成", type=bool) # 2.必要なオプションを追加
parser.add_argument('-t', '--tags', help="タグの設定、2つ目以降のタグは各「 #」を接頭辞", type=str)
args = parser.parse_args() # 3.オプションを解析

if not args.url:
print("ブログのURL：")
base_url = input()
else:
base_url = args.url

html = urlopen(base_url)
obj = BeautifulSoup(html, "html.parser")
data = obj.find('div', class_="entry-body")
dt_now = datetime.datetime.now()
dt_time = dt_now.strftime('%Y-%m-%d_%H%M%S')
title = obj.title.text.replace(' ', '　')
html = data
text = html2text.html2text(str(html), bodywidth=0)

#text = re.sub('^[ ]{4}', '', text, flags=re.MULTILINE)
text = re.sub('\n(\s*)\n|\n(\t*)\n', '\n\n',  text, flags=re.MULTILINE) #2行以上連続した改行を1行に置換
text = text.replace('', '')

if not args.tags:
tags =  ":CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #参考資料"
else:
tags = ":CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #{tags}".format(tags = args.tags.rstrip('\n'))

text = """
#### {title}

{tags}

{text}

最終更新日時：{date}

""".format(title=title, text=text, date=dt_time, tags=tags)

text = text[2:-1]

print(text)

if args.new:
file_name = title.replace('　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中', '')
if len(file_name) > 66:
    file_name = file_name[:66]

file_name = dt_time + '_' + file_name + '.md'
print(file_name)

path = '/home/a66/git/KK2022/wp/'
f=open(path + '/' + file_name, 'w')
f.write(text)
f.close

subprocess.run("sed -i -E s'/^    //' {file}".format(file=file_name), shell=True)



最終更新日時：2022-11-06_183532
get_text-wp-kk2022_platform.py --new True -l http://hirono-hideki.info/kk2022/2022-10-09_499
