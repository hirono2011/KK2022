### スクレイピングでファイルを作成するPythonスクリプトの改良（2）　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中

:CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #参考資料


　ブログでは問題がなかったのですが、固定ページの方で不具合が出たので、HTMLコードの構造から見直すことにしました。DIVやH1タグの直後は改行が入らないようなので改行タグを入れて対応してみました。

　プラグインを使うと意味不明のコードが入るのでそちらのコードも除去するようにしました。

#!python

"""
　WordPressの記事のテキストをURLを指定して取得。
　オプション--newで指定場所にファイルを作成
　オプション--tagsでタグを指定

　以下実行例

[~] get_text-wl-kk2022_arg.py -l http://hirono-hideki.info/kk2022/2022-10-06_174 --tags="ジャーナリストの江川紹子氏 #モトケンこと矢部善朗弁護士（京都弁護士会）"
### 「検察の汚名は一気に返上になるだろう。」というジャーナリスト清水潔氏のツイート　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中

:CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #ジャーナリストの江川紹子氏 #モトケンこと矢部善朗弁護士（京都弁護士会）

- TW NOSUKE0607（清水 潔） 日時： 2022/10/04 18:27:25 URL： https://twitter.com/NOSUKE0607/status/1577228890094723072  
> 元首相亡き今、特捜部が本気で前首相を狙っているなら検察の汚名は一気に返上になるだろう。さあやれるか検察。  
>   
> 東京地検特捜部が「菅前総理」をロック・オン…ひそかに進む「重大捜査」 https://t.co/Vgjq4MRthj  
元首相亡き今、特捜部が本気で前首相を狙っているなら検察の汚名は一気に返上になるだろう。さあやれるか検察。東京地検特捜部が「菅前総理」をロック・オン…ひそかに進む「重大捜査」 https://t.co/Vgjq4MRthj— 清水 潔 (@NOSUKE0607) October 4, 2022

最終更新日時：2022-10-06_141531

[~] 
"""

from bs4 import BeautifulSoup
from html.parser import HTMLParser
from urllib.request import urlopen
import sys
import pyperclip
import datetime
import re
import argparse
import html2text
import subprocess

#iargs = sys.argv
#base_url=args[1]

#base_url = pyperclip.paste().rstrip('\n')

parser = argparse.ArgumentParser() # 1.インスタンスの作成
parser.add_argument('-l', '--url', help="ブログ記事のURL", type=str) # 2.必要なオプションを追加
parser.add_argument('-n', '--new', help="新規に記録用ファイルを作成", type=bool) # 2.必要なオプションを追加
parser.add_argument('-t', '--tags', help="タグの設定、2つ目以降のタグは各「 #」を接頭辞", type=str)
args = parser.parse_args() # 3.オプションを解析

if not args.url:
    print("ブログのURL：")
    base_url = input()
else:
    base_url = args.url

html = urlopen(base_url)
obj = BeautifulSoup(html, "html.parser")
data = obj.find('div', class_="entry-body")
dt_now = datetime.datetime.now()
dt_time = dt_now.strftime('%Y-%m-%d_%H%M%S')
title = obj.title.text.replace(' ', '　')
html = str(data)
#print(data)
html = html.replace('</div>', '</div><br />')
html = html.replace('</h1>', '</h1><br />')
html = html.replace('</h2>', '</h2><br />')
html = html.replace('</h3>', '</h3><br />')
html = html.replace('</h4>', '</h4><br />')
html = re.sub('^<div class="printfriendly.+$', '', html, flags=re.MULTILINE)
html = re.sub('^<div aria-hidden="true" .+$', '', html, flags=re.MULTILINE)
html = re.sub('^<div class="linkcard">.+$', '', html, flags=re.MULTILINE)
#html = re.sub('^<div class="pf-content">\n.+</div><br />', '', html, flags=re.DOTALL)

#print(html)

text = html2text.html2text(html, bodywidth=0)
#print(text)

text = re.sub('^[ ]{4}', '', text, flags=re.MULTILINE)
text = re.sub('\n(\s*)\n|\n(\t*)\n', '\n\n',  text, flags=re.MULTILINE) #2行以上連続した改行を1行に置換
text = text.replace('', '')
text = re.sub('^  \* .+$', '', text, flags=re.MULTILINE)
#text = re.sub('^\[\!\[\]\(.+$', '', text, flags=re.MULTILINE)
text = re.sub('^\!\[\].+$', '', text, flags=re.MULTILINE)
text = re.sub('^\* .+$', '', text, flags=re.MULTILINE)
text = re.sub('^Contents$', '', text, flags=re.MULTILINE)

text = re.sub('\n{3,}', '\n', text, flags=re.MULTILINE)

if not args.tags:
    tags =  ":CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #参考資料"
else:
    tags = ":CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #{tags}".format(tags = args.tags.rstrip('\n'))

text = """
#### {title}

{tags}

{text}

最終更新日時：{date}

""".format(title=title, text=text, date=dt_time, tags=tags)

text = text[2:-1]

text = re.sub('\\-', '-', text, flags=re.MULTILINE)

print(text)

if args.new:
    file_name = title.replace('　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中', '')
    if len(file_name) > 66:
        file_name = file_name[:66]

    file_name = dt_time + '_' + file_name + '.md'
    print(file_name)

    path = '/home/a66/git/KK2022/wp/'
    f=open(path + '/' + file_name, 'w')
    f.write(text)
    f.close

    file_name = path + '/' + file_name
    # subprocess.run("sed -i -E s'/^    //' {file}".format(file=file_name), shell=True)
    # subprocess.run("sed -i -E s'/\\-/-/' {file}".format(file=file_name), shell=True)

  次が、上記のスクリプトの実行で作成したWordPressの固定ページのファイルの内容になります。

- 令和4年10月10日_告発状（作成開始日）　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中[ _http://hirono-hideki.info/kk2022/%e4%bb%a4%e5%92%8c4%e5%b9%b410%e6%9c%8810%e6%97%a5_%e5%91%8a%e7%99%ba%e7%8a%b6%ef%bc%88%e4%bd%9c%e6%88%90%e9%96%8b%e5%a7%8b%e6%97%a5%ef%bc%89_](http://hirono-hideki.info/kk2022/%e4%bb%a4%e5%92%8c4%e5%b9%b410%e6%9c%8810%e6%97%a5_%e5%91%8a%e7%99%ba%e7%8a%b6%ef%bc%88%e4%bd%9c%e6%88%90%e9%96%8b%e5%a7%8b%e6%97%a5%ef%bc%89)

[hbin] span9-get-title_url.py                                       16:58:42 

- 令和4年10月10日_告発状（作成開始日）　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中[ _http://hirono-hideki.info/kk2022/kk2022-10-10_start_](http://hirono-hideki.info/kk2022/kk2022-10-10_start)

　パーマリンクの変更をしました。

[wp] get_text-wp-kk2022-argparse.py -l http://hirono-hideki.info/kk2022/kk2022-10-10_start --tags="告発状" --new True                       15:39:34  ☁  main ☂ ✖ ⚡ ✭
### 令和4年10月10日_告発状（作成開始日）　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中

:CATEGORIES: @kanazawabengosi #金沢弁護士会 @JFBAsns 日本弁護士連合会（日弁連） #法務省 @MOJ_HOUMU #告発状

# 告発の趣旨

# 告発の趣旨

# 告発の事実

## 証拠資料

- 歴史と弁護士の謎に迫る：宮城県牡鹿郡女川町と福永活也弁護士　-　本件刑事告発・非常上告事件＼金沢地方検察庁御中[ _http://hirono-hideki.info/kk2022/2022-10-09_501#i_](http://hirono-hideki.info/kk2022/2022-10-09_501#i)

あああああああああああああ
ああああああ
あああ

ああああああああああ
あああああ
あああ

ああああ

最終更新日時：2022-10-10_170508

2022-10-10_170508_令和4年10月10日_告発状（作成開始日）.md

Follow me!


# 関連記事



[Pythonのライブラリ自作、GUIカレンダーからの日付入力](http://hirono-hideki.info/kk2022/2022-10-23_767)

 __2022-10-23_151636



[スクレイピングでファイルを作成するPythonスクリプトの改良](http://hirono-hideki.info/kk2022/2022-10-09_499)

 __2022-10-09_114853



[スクレイピングでWordPressの記事のテキストを取得し、ファイルも作成するPythonスクリプト](http://hirono-hideki.info/kk2022/2022-10-06_218)

 __2022-10-06_143135



[WordPressの記事をテキストデータで取得するpythonスクリプト](http://hirono-hideki.info/kk2022/2022-10-05_138)

 __2022-10-05_060843



最終更新日時：2022-10-24_200915
